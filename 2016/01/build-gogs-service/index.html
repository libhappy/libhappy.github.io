
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <link rel="canonical" href="https://libhappy.com/2016/01/build-gogs-service/index.html" />
    <script type="text/javascript">
        var host = "libhappy.com";
        if ((host == window.location.host) && (window.location.protocol != "https:"))
            window.location.protocol = "https";
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="LibHappy">
    <title>用Gogs搭建自己的Git服务器 - LibHappy</title>
    <meta name="author" content="Arthur">
    
    
        <link rel="icon" href="https://libhappy.com/assets/images/favicon.ico">
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="Git是非常流行的版本管理系统，很多的网站也提供了免费的Git服务，如全球知名的最大源代码托管服务Github。但是大部分的Git源代码托管服务都只对开放的代码托管免费，对私有的代码托管需要收取一定费用。同时，个人的一些代码有时由于各种原因可能并不适合开放，比如：练习用代码，对Git服务提供商的隐私性及安全性有所担忧，包含一些商业机密等等。此时可以搭建自己的Git服务器来托管代码。">
<meta property="og:type" content="blog">
<meta property="og:title" content="用Gogs搭建自己的Git服务器">
<meta property="og:url" content="https://libhappy.com/2016/01/build-gogs-service/index.html">
<meta property="og:site_name" content="LibHappy">
<meta property="og:description" content="Git是非常流行的版本管理系统，很多的网站也提供了免费的Git服务，如全球知名的最大源代码托管服务Github。但是大部分的Git源代码托管服务都只对开放的代码托管免费，对私有的代码托管需要收取一定费用。同时，个人的一些代码有时由于各种原因可能并不适合开放，比如：练习用代码，对Git服务提供商的隐私性及安全性有所担忧，包含一些商业机密等等。此时可以搭建自己的Git服务器来托管代码。">
<meta property="og:updated_time" content="2016-03-16T09:40:52.353Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="用Gogs搭建自己的Git服务器">
<meta name="twitter:description" content="Git是非常流行的版本管理系统，很多的网站也提供了免费的Git服务，如全球知名的最大源代码托管服务Github。但是大部分的Git源代码托管服务都只对开放的代码托管免费，对私有的代码托管需要收取一定费用。同时，个人的一些代码有时由于各种原因可能并不适合开放，比如：练习用代码，对Git服务提供商的隐私性及安全性有所担忧，包含一些商业机密等等。此时可以搭建自己的Git服务器来托管代码。">
    
    
        
    
    
        <meta property="og:image" content="https://libhappy.com/assets/images/avatar.png"/>
    
    
        
            <meta property="og:image" content="https://farm2.staticflickr.com/1642/24314364419_5387835599_q.jpg"/>
            <meta class="swiftype" name="image" data-type="enum" content="https://farm2.staticflickr.com/1642/24314364419_5387835599_q.jpg" />
        
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css" type="text/css">
    
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-68985881-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">LibHappy</a>
    </h1>
    
        
            <a  class="header-right-icon st-search-show-outputs"
                href="/#search">
        
        
            <i class="fa fa-lg fa-search"></i>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.png"/>
            </a>
            <span class="sidebar-profile-name">Arthur</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bars"></i>
                    <span class="sidebar-button-desc">Archives</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/timeline"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-history"></i>
                    <span class="sidebar-button-desc">Timeline</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-info-circle"></i>
                    <span class="sidebar-button-desc">About</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="/#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Search</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="http://git.libhappy.com/explore" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-git-square"></i>
                    <span class="sidebar-button-desc">Git</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            用Gogs搭建自己的Git服务器
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Sun Jan 03 2016 17:01:51 GMT+0800">
	
		    Jan 03, 2016
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Linux/">Linux</a>


    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>Git是非常流行的版本管理系统，很多的网站也提供了免费的Git服务，如全球知名的最大源代码托管服务<a href="http://github.com" target="_blank" rel="external">Github</a>。但是大部分的Git源代码托管服务都只对开放的代码托管免费，对私有的代码托管需要收取一定费用。同时，个人的一些代码有时由于各种原因可能并不适合开放，比如：练习用代码，对Git服务提供商的隐私性及安全性有所担忧，包含一些商业机密等等。此时可以搭建自己的Git服务器来托管代码。
<a id="more"></a>
应用最广泛的Git托管程序要数<a href="http://gitlab.com" target="_blank" rel="external">Gitlab</a>，它采用Ruby on Rails，可以实现一个自托管的Git项目仓库，并可以通过网页对公开的或者私人项目进行访问。其功能与Github相似，但搭建过程稍复杂且对系统的配置要求较高。因此我选用了另一个方案Gogs。
<div class="toc-class" id="table-of-contents"><h1>Table of Contents</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Gogs简介"><span class="toc-text">Gogs简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Gogs依赖环境"><span class="toc-text">Gogs依赖环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安装Git"><span class="toc-text">安装Git</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安装及配置MySQL数据库"><span class="toc-text">安装及配置MySQL数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装MySQL"><span class="toc-text">安装MySQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置MySQL"><span class="toc-text">配置MySQL</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#新建git用户"><span class="toc-text">新建git用户</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安装Go语言运行环境"><span class="toc-text">安装Go语言运行环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置环境变量"><span class="toc-text">配置环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Go"><span class="toc-text">安装Go</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安装Gogs"><span class="toc-text">安装Gogs</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#设置Nginx反向代理"><span class="toc-text">设置Nginx反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Nginx"><span class="toc-text">安装Nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置Nginx代理"><span class="toc-text">配置Nginx代理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Gogs运行的其他注意事项"><span class="toc-text">Gogs运行的其他注意事项</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#利用DropBox备份服务器文件"><span class="toc-text">利用DropBox备份服务器文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建DropBox应用"><span class="toc-text">创建DropBox应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取并设置DropBox上传下载脚本"><span class="toc-text">获取并设置DropBox上传下载脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#备份脚本"><span class="toc-text">备份脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设置备份脚本定时运行"><span class="toc-text">设置备份脚本定时运行</span></a></li></ol></li></ol></div></p>
<h1 id="Gogs简介">Gogs简介</h1><p><a href="http://gogs.io" target="_blank" rel="external">Gogs</a>是一款极易搭建的自助Git服务，在官网介绍中它有以下优点：</p>
<ul>
<li>易安装：除了可以根据操作系统平台下载二进制运行，还可以通过Docker或Vagrant，以及包管理安装。</li>
<li>跨平台：任何Go语言支持的平台都可以运行Gogs，包括Windows、Mac、Linux 以及ARM。</li>
<li>轻量级：一个廉价的树莓派的配置足以满足Gogs的最低系统硬件要求。有些用户甚至还将Gogs运行在NAS设备上。</li>
<li>开源化：所有的代码都开源在<a href="https://github.com/gogits/gogs/" target="_blank" rel="external">GitHub</a>。</li>
</ul>
<p>具体的界面可以到官方提供的<a href="https://try.gogs.io/" target="_blank" rel="external">在线体验</a>界面查看。
需要注意的是，Gogs现在还在开发中，在某些具体功能上还不及Gitlab，但相信随着后续的开发功能一定会越来越完备的。</p>
<h1 id="Gogs依赖环境">Gogs依赖环境</h1><p>安装Gogs之前需要配置相应的依赖环境，官网介绍的依赖环境如下：</p>
<ul>
<li>数据库（选择以下一项）：<ul>
<li>MySQL：版本 &gt;= 5.5.3</li>
<li>PostgreSQL</li>
<li>或者 什么都不安装 直接使用 SQLite3 或 TiDB</li>
</ul>
</li>
<li>git（bash）：<ul>
<li>服务端和客户端均需版本 &gt;= 1.7.1</li>
<li>Windows 系统建议使用最新版</li>
</ul>
</li>
<li>SSH 服务器：<ul>
<li>如果您只使用 HTTP/HTTPS 或者内置 SSH 服务器的话请忽略此项</li>
<li>推荐 Windows 系统使用 Cygwin OpenSSH 或 Copssh</li>
</ul>
</li>
<li>Nginx反向代理（可选）</li>
</ul>
<p>以下以Ubuntu服务器为例安装Gogs。</p>
<h1 id="安装Git">安装Git</h1><p>安装Git:
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure></p>
<p>检查Git是否安装成功:
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git --version</span><br></pre></td></tr></table></figure></p>
<h1 id="安装及配置MySQL数据库">安装及配置MySQL数据库</h1><h2 id="安装MySQL">安装MySQL</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install mysql-server</span><br></pre></td></tr></table></figure>
<p>安装时需要配置MySQL的root用户及密码。
检查MySQL是否安装成功
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql --version</span><br></pre></td></tr></table></figure></p>
<h2 id="配置MySQL">配置MySQL</h2><p>创建gogs数据库，配置数据库编码为utf8，数据库引擎为InnoDB。
<figure class="highlight sh"><figcaption><span>mysql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">mysql&gt; SET GLOBAL storage_engine = <span class="string">'InnoDB'</span>;</span><br><span class="line">mysql&gt; CREATE DATABASE gogs CHARACTER SET utf8 COLLATE utf8_bin;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON gogs.* TO ‘root’@‘localhost’ IDENTIFIED BY ‘password’;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">mysql&gt; QUIT;</span><br></pre></td></tr></table></figure></p>
<h1 id="新建git用户">新建git用户</h1><p>为运行Gogs创建一个新的用户git：
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo adduser git</span><br></pre></td></tr></table></figure></p>
<p>然后按照提示设置相关用户信息及密码。在后文中运行Gogs时需要以该用户身份运行。</p>
<h1 id="安装Go语言运行环境">安装Go语言运行环境</h1><p>Gogs由Go语言编写，运行时需要安装Golang运行环境。如果系统中其他程序并不需要运行Go语言程序，可以只为上文创建的git用户配置运行环境，也可以选择配置全系统所有用户的Go语言运行环境。</p>
<h2 id="配置环境变量">配置环境变量</h2><p>切换到用户git，并只为该用户配置Go运行环境。
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su git</span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">mkdir go</span><br></pre></td></tr></table></figure></p>
<p>写入环境变量：
<figure class="highlight sh"><figcaption><span>.bashrc</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GOROOT=<span class="variable">$HOME</span>/go</span><br><span class="line"><span class="built_in">export</span> GOARCH=<span class="number">386</span>   <span class="comment">#系统位数，386表示32位系统，amd64表示64位系统。</span></span><br><span class="line"><span class="built_in">export</span> GOOS=linux   <span class="comment">#系统类型</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOROOT</span>/bin</span><br></pre></td></tr></table></figure>
使环境变量生效：
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure></p>
<h2 id="安装Go">安装Go</h2><p><a href="https://golang.org/dl/" target="_blank" rel="external">Go语言官网</a>可以获取最新的二进制安装包：
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://storage.googleapis.com/golang/go1.<span class="number">5.2</span>.linux-<span class="number">386</span>.tar.gz</span><br><span class="line">tar xzvf go1.<span class="number">5.2</span>.linux-<span class="number">386</span>.tar.gz</span><br><span class="line">mv go <span class="variable">$GOROOT</span></span><br></pre></td></tr></table></figure></p>
<p>Go语言运行环境就安装完成了，测试Golang是否安装成功：
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go env</span><br></pre></td></tr></table></figure></p>
<h1 id="安装Gogs">安装Gogs</h1><p>访问<a href="https://gogs.io/docs/installation/install_from_binary" target="_blank" rel="external">Gogs官网</a>可以获取最新的Gogs二进制安装包。
<figure class="highlight sh"><figcaption><span>git@computer:~</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir goapp</span><br><span class="line"><span class="built_in">cd</span> goapp</span><br><span class="line">wget https://storage.googleapis.com/golang/go1.<span class="number">5.2</span>.linux-<span class="number">386</span>.tar.gz</span><br><span class="line">tar xzvf go1.<span class="number">5.2</span>.linux-<span class="number">386</span>.tar.gz</span><br></pre></td></tr></table></figure>
Gogs程序就安装到了<code>~/goapp</code>目录下，可以直接运行gogs。
<figure class="highlight"><figcaption><span>git@computer:~/goapp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd gogs&#10;./gogs web</span><br></pre></td></tr></table></figure>
Gogs默认监听3000端口，此时用浏览器打开服务器IP的3000端口(服务器IP:3000)，在网页中进行初始配置。
需要注意的是，<em>首次运行时建议设置Gogs的管理员账户</em>，拖动到网页最下方填写管理员用户及密码即可。</p>
<h1 id="设置Nginx反向代理">设置Nginx反向代理</h1><p>Gogs默认监听3000端口，使用Nginx将80端口的访问代理至3000端口即可直接通过IP访问Gogs，绑定域名后还可以通过域名访问。</p>
<h2 id="安装Nginx">安装Nginx</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nginx</span><br></pre></td></tr></table></figure>
<h2 id="配置Nginx代理">配置Nginx代理</h2><p>为Gogs创建一个Nginx配置文件：
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/nginx/sites-available/gogs</span><br></pre></td></tr></table></figure></p>
<p>写入以下配置：
<figure class="highlight plain"><figcaption><span>/etc/nginx/sites-available/gogs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server &#123;&#10;    listen 80;&#10;    server_name your_server_ip; # your_server_ip&#20026;&#26381;&#21153;&#22120;IP&#25110;&#32465;&#23450;&#30340;&#22495;&#21517;&#10;&#10;    location / &#123;&#10;        proxy_pass http://127.0.0.1:3000;&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
保存后将该配置文件链接到<code>sites-enabled</code>中。
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln <span class="operator">-s</span> /etc/nginx/sites-available/gogs /etc/nginx/sites-enabled/gogs</span><br></pre></td></tr></table></figure></p>
<p>重启nginx：
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx restart</span><br></pre></td></tr></table></figure></p>
<p>然后就可以直接通过域名或IP访问Gogs了。</p>
<h1 id="Gogs运行的其他注意事项">Gogs运行的其他注意事项</h1><p>至此Gogs服务就安装完成了。Gogs运行时还有以下注意事项：</p>
<ol>
<li><p>Gogs的自定义配置文件位于<code>gogs/custom/conf/app.ini</code>，具体的参数配置可以参考官方的<a href="https://gogs.io/docs/advanced/configuration_cheat_sheet.html" target="_blank" rel="external">配置文件手册</a>。比如，如果修改了ssh的默认端口，就需要在自定义配置文件中指定修改后的ssh端口：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSH_PORT: <span class="number">8888</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>gogs/scripts</code>文件目录中针对不同服务管理软件的已经配置好的Gogs启动脚本文件，比如<code>supervisor</code>脚本的内容如下：</p>
<figure class="highlight plain"><figcaption><span>gogs/scripts/supervisor/gogs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[program:gogs]&#10;directory=/home/git/go/src/github.com/gogits/gogs/&#10;command=/home/git/go/src/github.com/gogits/gogs/gogs web&#10;autostart=true&#10;autorestart=true&#10;startsecs=10&#10;stdout_logfile=/var/log/gogs/stdout.log&#10;stdout_logfile_maxbytes=1MB&#10;stdout_logfile_backups=10&#10;stdout_capture_maxbytes=1MB&#10;stderr_logfile=/var/log/gogs/stderr.log&#10;stderr_logfile_maxbytes=1MB&#10;stderr_logfile_backups=10&#10;stderr_capture_maxbytes=1MB&#10;user = git&#10;environment = HOME=&#34;/home/git&#34;, USER=&#34;git&#34;</span><br></pre></td></tr></table></figure>
<p>修改一些文件路径及参数后就能够直接使用该文件在supervisor中设置Gogs的自动启动。</p>
</li>
<li>Gogs的托管的仓库文件默认位于<code>~/gogs-repositories/</code>文件夹中。</li>
</ol>
<h1 id="利用DropBox备份服务器文件">利用DropBox备份服务器文件</h1><p>通过自建的Git服务器来托管代码后，定时备份数据文件就显得格外重要了。一旦服务器出现故障而无法恢复，所有已上传的代码库也将丢失。<a href="https://db.tt/829rVOUg" target="_blank" rel="external">DropBox</a>是国外非常受信赖的云同步服务，虽然DropBox提供的免费空间较小，但用来备份个人代码文件还是足够的。而且DropBox提供了完善的API接口，可以通过命令行直接上传下载文件，当服务器位于海外时同步速度也十分令人满意。下面介绍如何将服务器中的数据备份至DropBox中。</p>
<h2 id="创建DropBox应用">创建DropBox应用</h2><p>首先需要创建一个DropBox应用来利用DropBox的API，直接点击该网址创建：<a href="https://www.dropbox.com/developers/apps/create" target="_blank" rel="external">https://www.dropbox.com/developers/apps/create</a>。
创建应用时的一些选项如下：</p>
<ul>
<li>Choose an API（应用类型）：DropBox API</li>
<li>Choose the type of access you need（数据访问类型）：App folder</li>
<li>Name your app（应用名称，取一个喜欢的即可）：GogsBackup</li>
</ul>
<p>应用创建后就可以获得<code>App key</code>和<code>App sercet</code>，保存这两行字符。</p>
<h2 id="获取并设置DropBox上传下载脚本">获取并设置DropBox上传下载脚本</h2><p><a href="https://github.com/andreafabrizi/Dropbox-Uploader/" target="_blank" rel="external">Dropbox-Uploader</a>是一个第三方的DropBox上传下载脚本。首先获取该脚本并为其设置可执行权限：
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/tennfy/Dropbox-Uploader/master/dropbox_uploader.sh</span><br><span class="line">chmod a+x dropbox_uploader.sh</span><br></pre></td></tr></table></figure></p>
<p>直接运行该脚本，第一次运行时会连接DropBox验证权限。
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./dropbox_uploader.sh</span><br></pre></td></tr></table></figure></p>
<p>按照提示输入上文中保存的<code>App key</code>和<code>App sercet</code>，Permission type选择<code>a</code>。然后在浏览器中打开给出的连接地址，给予权限。以后运行时就不用再次验证了。
<em>注意</em>：这个授权的过程只是针对当前登陆ssh的用户，并非全局，如果切换用户运行脚本，会提示再次进行授权，因此应提前切换到需要运行该脚本的用户进行授权。其实当前用户的授权信息保存在<code>~/.dropbox_uploader</code>文件中，因此切换用户后会提示首次运行需要进行授权。</p>
<h2 id="备份脚本">备份脚本</h2><p>参考<a href="http://www.tennfy.com/3343.html" target="_blank" rel="external">定时备份VPS数据至Dropbox教程</a>给出的备份脚本，修改相应参数即可。
<figure class="highlight sh"><figcaption><span>backup.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 指定dropbox_uploader.sh脚本的保存目录</span></span><br><span class="line">SCRIPT_DIR=<span class="string">"/root/backup"</span></span><br><span class="line"><span class="comment"># 上传到DropBox的文件夹</span></span><br><span class="line">DROPBOX_DIR=<span class="string">"/backup/<span class="variable">$(date +"%Y.%m.%d")</span>"</span></span><br><span class="line"><span class="comment"># 需要保存的服务器文件夹，可以用空格隔开多个文件夹</span></span><br><span class="line">BACKUP_SRC=<span class="string">"/home/git/gogs-repositories"</span></span><br><span class="line"><span class="comment"># 服务器上临时的备份保存文件夹</span></span><br><span class="line">LOCAL_BAK_DIR=<span class="string">"/root/backup"</span></span><br><span class="line"><span class="comment"># MySQL相应配置</span></span><br><span class="line">MYSQL_SERVER=<span class="string">"localhost"</span></span><br><span class="line">MYSQL_USER=<span class="string">"root"</span></span><br><span class="line">MYSQL_PASS=<span class="string">"1325xlg"</span></span><br><span class="line"><span class="comment"># 数据备份压缩后的文件名称</span></span><br><span class="line">DBBakName=Data_$(date +<span class="string">"%Y%m%d"</span>).tar.gz</span><br><span class="line">WebBakName=Web_$(date +<span class="string">"%Y%m%d"</span>).tar.gz</span><br><span class="line"><span class="comment"># 已过期备份数据的名称（3天前的数据会被删除）</span></span><br><span class="line">Old_DROPBOX_DIR=<span class="string">"/backup/<span class="variable">$(date -d -3day +"%Y.%m.%d")</span>"</span></span><br><span class="line">OldDBBakName=Data_$(date <span class="operator">-d</span> -<span class="number">3</span>day +<span class="string">"%Y%m%d"</span>).tar.gz</span><br><span class="line">OldWebBakName=Web_$(date <span class="operator">-d</span> -<span class="number">3</span>day +<span class="string">"%Y%m%d"</span>).tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出MySQL数据库备份（所有数据库），并压缩为指定文件名</span></span><br><span class="line">mysqldump -u <span class="variable">$MYSQL_USER</span> -h <span class="variable">$MYSQL_SERVER</span> -p<span class="variable">$MYSQL_PASS</span> --events --all-databases &gt; <span class="variable">$LOCAL_BAK_DIR</span>/Database.sql</span><br><span class="line">tar zcvf <span class="variable">$LOCAL_BAK_DIR</span>/<span class="variable">$DBBakName</span> <span class="variable">$LOCAL_BAK_DIR</span>/Database.sql</span><br><span class="line">rm -rf <span class="variable">$LOCAL_BAK_DIR</span>/Database.sql</span><br><span class="line"><span class="comment"># 压缩需要保存的文件夹为指定文件名</span></span><br><span class="line">tar zcvf <span class="variable">$LOCAL_BAK_DIR</span>/<span class="variable">$WebBakName</span> <span class="variable">$BACKUP_SRC</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传压缩后的备份文件到指定的DropBox目录</span></span><br><span class="line"><span class="variable">$SCRIPT_DIR</span>/dropbox_uploader.sh upload <span class="variable">$LOCAL_BAK_DIR</span>/<span class="variable">$DBBakName</span> <span class="variable">$DROPBOX_DIR</span>/<span class="variable">$DBBakName</span></span><br><span class="line"><span class="variable">$SCRIPT_DIR</span>/dropbox_uploader.sh upload <span class="variable">$LOCAL_BAK_DIR</span>/<span class="variable">$WebBakName</span> <span class="variable">$DROPBOX_DIR</span>/<span class="variable">$WebBakName</span></span><br><span class="line"><span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"upload done!"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传完成后删除服务器上及DropBox中已经过期的备份数据，节省空间</span></span><br><span class="line">rm -rf <span class="variable">$LOCAL_BAK_DIR</span>/<span class="variable">$OldDBBakName</span> <span class="variable">$LOCAL_BAK_DIR</span>/<span class="variable">$OldWebBakName</span></span><br><span class="line"><span class="variable">$SCRIPT_DIR</span>/dropbox_uploader.sh delete <span class="variable">$Old_DROPBOX_DIR</span>/</span><br><span class="line"><span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"delete old backup done"</span></span><br></pre></td></tr></table></figure>
然后为该脚本增加运行权限：
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x ./backup.sh</span><br></pre></td></tr></table></figure></p>
<p>现在可以直接运行该脚本，测试其是否能够成功备份文件并上传至DropBox。</p>
<h2 id="设置备份脚本定时运行">设置备份脚本定时运行</h2><p>通过cron程序可以设定程序定时运行。需要注意的是cron运行是分用户的，某个用户设定的定时任务运行时会以该用户的权限运行。因此要注意上文中提到的dropbox_uploader运行用户的问题。
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su root <span class="comment"># 切换到合适用户执行定时任务</span></span><br><span class="line">crontab <span class="operator">-e</span></span><br></pre></td></tr></table></figure></p>
<p>编辑定时任务，文件注释中有十分详细的说明：
<figure class="highlight plain"><figcaption><span>crontab -e</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Edit this file to introduce tasks to be run by cron.&#10;#&#10;# Each task to run has to be defined through a single line&#10;# indicating with different fields when the task will be run&#10;# and what command to run for the task&#10;#&#10;# To define the time you can provide concrete values for&#10;# minute (m), hour (h), day of month (dom), month (mon),&#10;# and day of week (dow) or use &#39;*&#39; in these fields (for &#39;any&#39;).#&#10;# Notice that tasks will be started based on the cron&#39;s system&#10;# daemon&#39;s notion of time and timezones.&#10;#&#10;# Output of the crontab jobs (including errors) is sent through&#10;# email to the user the crontab file belongs to (unless redirected).&#10;#&#10;# For example, you can run a backup of all your user accounts&#10;# at 5 a.m every week with:&#10;# 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/&#10;#&#10;# For more information see the manual pages of crontab(5) and cron(8)&#10;#&#10;# m h  dom mon dow   command#&#10;0 3 * * * /bin/bash /root/backup/backup.sh</span><br></pre></td></tr></table></figure>
以上命令表示每天早上3:00执行命令<code>/bin/bash /root/backup/backup.sh</code>。
如果没有设置服务器时区或者不知道服务器时间，可以通过命令<code>date</code>来查看服务器的当前时间。
设置完成后，重启cron服务：
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service cron restart</span><br></pre></td></tr></table></figure></p>
<p>然后，定时任务就会自动执行了。</p>
<p>参考文章：</p>
<ol>
<li><a href="https://mynook.info/blog/post/host-your-own-git-server-using-gogs" target="_blank" rel="external">使用 Gogs 搭建自己的 Git 服务器</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-gogs-on-ubuntu-14-04" target="_blank" rel="external">How To Set Up Gogs on Ubuntu 14.04</a></li>
<li><a href="http://my.oschina.net/luyao/blog/375654?fromerr=xhqsCTAb" target="_blank" rel="external">阿里云上Ubuntu14.04-64位安装Gogs</a></li>
<li><a href="http://keenwon.com/449.html" target="_blank" rel="external">自动定时备份VPS – 如何搭建个人网站</a></li>
<li><a href="http://www.tennfy.com/3343.html" target="_blank" rel="external">定时备份VPS数据至Dropbox教程</a></li>
</ol>

            
                

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/git/">git</a> <a class="tag tag--primary tag--small t-link" href="/tags/gogs/">gogs</a> <a class="tag tag--primary tag--small t-link" href="/tags/vps/">vps</a> <a class="tag tag--primary tag--small t-link" href="/tags/备份/">备份</a>

            </div>
        
        <div class="post-actions-wrap">
    
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/03/algs-0.0/"  data-tooltip="普林斯顿算法（0.0）简介">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/12/vps-protect/" data-tooltip="Linux服务器的简单防护">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=https://libhappy.com/2016/01/build-gogs-service/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://libhappy.com/2016/01/build-gogs-service/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=https://libhappy.com/2016/01/build-gogs-service/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" data-tooltip="View comments" href="#ds-thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" data-tooltip="Back to Index" href="#table-of-contents">
                    <i class="fa fa-list-ul"></i>
            
            </a>
        </li>
    </ul>
</div>


        
            
                <div id="ds-thread" class="ds-thread" data-thread-key="2016/01/build-gogs-service/"
     data-title="用Gogs搭建自己的Git服务器" data-url="https://libhappy.com/2016/01/build-gogs-service/">
</div>

            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 Arthur. All Rights Reserved.<br>
        Static pages hosted in <a class="theme-link" href="https://github.com/" rel="external nofollow">Github</a>, Pictures hosted in <a class="theme-link" href="https://www.flickr.com/photos/walktodream/albums/72157659807930798" rel="external nofollow">Flickr</a>
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="1">
                    <div class="post-actions-wrap">
    
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/03/algs-0.0/"  data-tooltip="普林斯顿算法（0.0）简介">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/12/vps-protect/" data-tooltip="Linux服务器的简单防护">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=https://libhappy.com/2016/01/build-gogs-service/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://libhappy.com/2016/01/build-gogs-service/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=https://libhappy.com/2016/01/build-gogs-service/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" data-tooltip="View comments" href="#ds-thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" data-tooltip="Back to Index" href="#table-of-contents">
                    <i class="fa fa-list-ul"></i>
            
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="1">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https://libhappy.com/2016/01/build-gogs-service/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google+</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://libhappy.com/2016/01/build-gogs-service/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://libhappy.com/2016/01/build-gogs-service/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.png"/>
        
            <h4 id="about-card-name">Arthur</h4>
        
            <h5 id="about-card-bio"><p>Happy coding, Happy life.</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Whatever</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                China
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/scrip.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->

    
        <script type="text/javascript">
            var duoshuoQuery = {short_name:'libhappy'};
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';ds.async = true;
                ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
        </script>
    


    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
                (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
            e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','xKFF8yFHuuQLQqpiGZt3','2.0.0');
    </script>


</html>
