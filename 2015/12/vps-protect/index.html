
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="LibHappy">
    <title>Linux服务器的简单防护 - LibHappy</title>
    <meta name="author" content="Arthur">
    
        <link rel="icon" href="/assets/images/favicon.ico">
    
    
        <link rel="alternative" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="在购买自己的VPS之后，首先要做好的就是安全防护工作，本文将主要介绍以下方式来提高VPS的安全防护能力：

修改ssh默认端口，开启密钥登陆并关闭简单密码登录
开启iptables防火墙，关闭不必要端口的入站连接">
<meta property="og:type" content="blog">
<meta property="og:title" content="Linux服务器的简单防护">
<meta property="og:url" content="http://libhappy.com/2015/12/vps-protect/index.html">
<meta property="og:site_name" content="LibHappy">
<meta property="og:description" content="在购买自己的VPS之后，首先要做好的就是安全防护工作，本文将主要介绍以下方式来提高VPS的安全防护能力：

修改ssh默认端口，开启密钥登陆并关闭简单密码登录
开启iptables防火墙，关闭不必要端口的入站连接">
<meta property="og:updated_time" content="2015-12-16T05:02:03.476Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux服务器的简单防护">
<meta name="twitter:description" content="在购买自己的VPS之后，首先要做好的就是安全防护工作，本文将主要介绍以下方式来提高VPS的安全防护能力：

修改ssh默认端口，开启密钥登陆并关闭简单密码登录
开启iptables防火墙，关闭不必要端口的入站连接">
    
    
    
        <meta property="og:image" content="/assets/images/avatar.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css" type="text/css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-68985881-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

</head>

    <body>
        <div id="blog">
            <header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">LibHappy</a>
    </h1>
    
        
            <a  class="header-right-icon st-search-show-outputs"
                href="/#search">
        
                <i class="fa fa-lg fa-search"></i>
            </a>
    
</header>
            <nav id="sidebar" data-behavior="1">
    
        <div class="sidebar-profile">
            <a href="/#about">
                
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg"/>
                
            </a>
            <span class="sidebar-profile-name">Arthur</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bars"></i>
                    <span class="sidebar-button-desc">Archives</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="/#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Search</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-info-circle"></i>
                    <span class="sidebar-button-desc">About</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/libhappy" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github-square"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            Linux服务器的简单防护
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Mon Dec 14 2015 09:59:04 GMT+0800">
	
		    Dec 14, 2015
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Linux/">Linux</a>


    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>在购买自己的VPS之后，首先要做好的就是安全防护工作，本文将主要介绍以下方式来提高VPS的安全防护能力：</p>
<ul>
<li>修改ssh默认端口，开启密钥登陆并关闭简单密码登录</li>
<li>开启iptables防火墙，关闭不必要端口的入站连接</li>
</ul>
<a id="more"></a>
<h1 id="table-of-contents">Table of Contents</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ssh设置"><span class="toc-text">ssh设置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#修改默认端口"><span class="toc-text">修改默认端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#禁用root登陆"><span class="toc-text">禁用root登陆</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#新建用户"><span class="toc-text">新建用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#将用户加入sudo组"><span class="toc-text">将用户加入sudo组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#禁用root登陆-1"><span class="toc-text">禁用root登陆</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#禁用简单密码登录，使用密钥登陆"><span class="toc-text">禁用简单密码登录，使用密钥登陆</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建密钥"><span class="toc-text">创建密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上传公钥至服务器"><span class="toc-text">上传公钥至服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置密钥"><span class="toc-text">设置密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启用密钥并禁用密码登录"><span class="toc-text">启用密钥并禁用密码登录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#iptables防火墙设置"><span class="toc-text">iptables防火墙设置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#查看iptables列表"><span class="toc-text">查看iptables列表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iptables_命令解释"><span class="toc-text">iptables 命令解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#允许连接"><span class="toc-text">允许连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#阻止其他连接"><span class="toc-text">阻止其他连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编辑已存在规则"><span class="toc-text">编辑已存在规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#删除一条规则"><span class="toc-text">删除一条规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#插入一条规则"><span class="toc-text">插入一条规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#保存规则与恢复规则"><span class="toc-text">保存规则与恢复规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#手动保存规则"><span class="toc-text">手动保存规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动保存规则"><span class="toc-text">自动保存规则</span></a></li></ol></li></ol></li></ol>
<h1 id="ssh设置">ssh设置</h1><h2 id="修改默认端口">修改默认端口</h2><p>修改/etc/ssh/sshd_config文件：<br><figure class="highlight vhdl"><figcaption><span>/etc/ssh/sshd_config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># What ports, IPs <span class="keyword">and</span> protocols we listen <span class="keyword">for</span></span><br><span class="line"><span class="keyword">Port</span> <span class="number">12345</span></span><br></pre></td></tr></table></figure></p>
<p>将ssh默认端口<code>22</code>改为一个随机的端口。<br>注意：小于<code>1024</code>的端口为系统默认分配给特定服务的端口，不建议随意占用。</p>
<h2 id="禁用root登陆">禁用root登陆</h2><p>开启root用户登录使得攻击者可以轻易的猜到可登陆的用户名，同时使用高权限用户操作，如果操作错误容易引起无法恢复的系统错误。因此建议新建一个普通用户登陆，并加入sudo组，在需要时可执行高权限命令，或者直接切换到root用户操作。</p>
<h3 id="新建用户">新建用户</h3><p>新建用户testuser:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adduser testuser</span><br></pre></td></tr></table></figure></p>
<p>接下来会提示输入该用户的相关信息，显示如下：<br><figure class="highlight crmsh"><figcaption><span>adduser testuser</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Adding <span class="keyword">user</span> <span class="title">`testuser</span>' ...</span><br><span class="line">Adding new <span class="keyword">group</span> <span class="title">`testuser</span>' (<span class="number">1001</span>) ...</span><br><span class="line">Adding new <span class="keyword">user</span> <span class="title">`testuser</span>' (<span class="number">1001</span>) with <span class="keyword">group</span> <span class="title">`testuser</span>' ...</span><br><span class="line">Creating home directory `/home/testuser' ...</span><br><span class="line">Copying files from `/etc/skel' ...</span><br><span class="line">Enter new UNIX password:</span><br><span class="line">Retype new UNIX password:</span><br><span class="line">passwd: password updated successfully</span><br><span class="line">Changing the <span class="keyword">user</span> <span class="title">information</span> for testuser</span><br><span class="line">Enter the new value, <span class="operator">or</span> press ENTER for the default</span><br><span class="line">    Full Name []:</span><br><span class="line">    Room <span class="type">Number</span> []:</span><br><span class="line">    Work Phone []:</span><br><span class="line">    Home Phone []:</span><br><span class="line">    Other []:</span><br><span class="line">Is the <span class="number">inf</span>ormation correct? [Y/n] y</span><br></pre></td></tr></table></figure><br>按照提示输入相关信息后，确认信息正确，则该用户创建完成。</p>
<h3 id="将用户加入sudo组">将用户加入sudo组</h3><p>将用户加入sudo组，在需要执行高权限命令时可以直接在命令前加sudo执行。给某用户赋予sudo权限需要修改/etc/sudoers文件，但是sudoers文件一旦修改错误易造成系统权限混乱，因此不建议直接修改sudoers文件。事实上sudoers文件默认对所有用户（包括root用户）都是只读权限。修改sudoers文件建议通过程序<strong>visudo</strong>进行，visudo在修改sudoers文件之前会对用户的更改进行检测，当没有出现错误时再将修改写入sudoers文件。<br>以管理员权限执行命令visudo<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">visudo</span><br></pre></td></tr></table></figure></p>
<p>在<code># User privilege specification</code>行下加入如下行：<br><figure class="highlight apache"><figcaption><span>visudo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># User privilege specification</span></span><br><span class="line"><span class="keyword">root</span>    <span class="literal">ALL</span>=(<span class="literal">ALL</span>:<span class="literal">ALL</span>) <span class="literal">ALL</span></span><br><span class="line"><span class="keyword">testuser</span>  <span class="literal">ALL</span>=(<span class="literal">ALL</span>:<span class="literal">ALL</span>) <span class="literal">ALL</span> # 加入这一行</span><br></pre></td></tr></table></figure><br>保存退出。</p>
<h3 id="禁用root登陆-1">禁用root登陆</h3><p>修改sshd_config文件，禁用root登陆<br><figure class="highlight nginx"><figcaption><span>/etc/ssh/sshd_config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">PermitRootLogin</span> <span class="built_in">no</span></span><br></pre></td></tr></table></figure></p>
<p>然后重启ssh使配置生效：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ssh restart</span><br></pre></td></tr></table></figure></p>
<p>注意：以上每次修改sshd_config后都可以重启ssh，然后退出当前ssh连接，再按照新的配置登陆ssh，以验证配置的正确。</p>
<h2 id="禁用简单密码登录，使用密钥登陆">禁用简单密码登录，使用密钥登陆</h2><p>禁用简单密码登录能够防止对服务器猜测密码的暴力破解。</p>
<h3 id="创建密钥">创建密钥</h3><p>首先要创建使用rsa算法加密的公私密钥：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure></p>
<p>输出如下：<br><figure class="highlight gherkin"><figcaption><span>ssh-keygen -t rsa</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/home/testuser/.ssh/id_rsa):</span><br><span class="line">Enter passphrase (empty for no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in ./test_rsa.</span><br><span class="line">Your public key has been saved in ./test_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx testuser<span class="comment">@vps</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">          xx.    </span>|</span><br><span class="line">|<span class="string"> .       ..      </span>|</span><br><span class="line">|<span class="string">  .x***..        </span>|</span><br><span class="line">|<span class="string">       .  .  *   </span>|</span><br><span class="line">|<span class="string">  ==   .-.       </span>|</span><br><span class="line">|<span class="string">     .    x      </span>|</span><br><span class="line">|<span class="string">X.  + &gt;_&lt;!       </span>|</span><br><span class="line">|<span class="string"> .X  *= - x      </span>|</span><br><span class="line">|<span class="string">.. ..+**         </span>|</span><br><span class="line">+-----------------+</span><br></pre></td></tr></table></figure></p>
<p>会提示输入密钥保存的位置与名称、密钥密码，密钥密码用以保护密钥，在使用密钥时同时需要输入该密码。如果私钥被窃取，没有密码也无法使用该密钥。如果不想要密码，在要求设置密码时直接按回车键跳过密码输入。</p>
<h3 id="上传公钥至服务器">上传公钥至服务器</h3><p>生成公私钥后，将公钥上传至服务器。如果是在服务器生成的密钥，则需要将私钥传回客户端并删除服务器上的私钥。<br>使用 scp 命令上传公钥：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp ./ssh/id_rsa.pub usertest@remote_ssh:</span><br></pre></td></tr></table></figure></p>
<h3 id="设置密钥">设置密钥</h3><p>将上传的公钥保存到当前用户的<code>~/.ssh</code>目录下，并重命名为authorized_keys<br><figure class="highlight stylus"><figcaption><span>~</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv id_rsa<span class="class">.pub</span> ./.ssh/authorized_keys</span><br></pre></td></tr></table></figure></p>
<p>同时，为了安全可以设置.ssh目录以及authorized_keys的权限<br><figure class="highlight cpp"><figcaption><span>~</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod <span class="number">700</span> -R .ssh</span><br><span class="line">chmod <span class="number">400</span> ./.ssh/authorized_keys</span><br></pre></td></tr></table></figure></p>
<h3 id="启用密钥并禁用密码登录">启用密钥并禁用密码登录</h3><p>编辑/etc/ssh/sshd_config文件，修改以下项目：<br><figure class="highlight nginx"><figcaption><span>/etc/ssh/sshd_config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">RSAAuthentication</span> <span class="built_in">yes</span>      <span class="comment">#RSA认证</span></span><br><span class="line">PubkeyAuthentication <span class="built_in">yes</span>   <span class="comment">#开启公钥验证</span></span><br><span class="line">AuthorizedKeysFile .ssh/authorized_keys <span class="comment">#验证文件路径</span></span><br><span class="line">PasswordAuthentication <span class="built_in">no</span>  <span class="comment">#禁止密码认证</span></span><br><span class="line">PermitEmptyPasswords <span class="built_in">no</span>    <span class="comment">#禁止空密码</span></span><br><span class="line">UsePAM <span class="built_in">no</span>                  <span class="comment">#禁用PAM</span></span><br></pre></td></tr></table></figure></p>
<p>然后保存，重启ssh服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /etc/init.d/ssh restart</span><br></pre></td></tr></table></figure></p>
<p>现在，退出当前ssh连接，使用密钥就可以登录服务器了。</p>
<h1 id="iptables防火墙设置">iptables防火墙设置</h1><p>Ubuntu自带了非常简单但功能强大的防火墙iptables，如果不配置规则，默认是允许所有流量的。</p>
<h2 id="查看iptables列表">查看iptables列表</h2><p>用以下命令可以查看已经生效的iptables规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -L</span><br></pre></td></tr></table></figure></p>
<p>显示如下：<br><figure class="highlight lisp"><figcaption><span>sudo iptables -L</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Chain INPUT <span class="list">(<span class="keyword">policy</span> ACCEPT)</span></span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD <span class="list">(<span class="keyword">policy</span> ACCEPT)</span></span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT <span class="list">(<span class="keyword">policy</span> ACCEPT)</span></span><br><span class="line">target     prot opt source               destination</span><br></pre></td></tr></table></figure></p>
<p>默认是没有任何规则的。也可以加上<code>-v</code>选项查看更为详细的信息。<br>命令ifconfig可以查看网络接口信息:<br><figure class="highlight cpp"><figcaption><span>ifconfig</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  Mask:<span class="number">255.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">          inet6 addr: ::<span class="number">1</span>/<span class="number">128</span> Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:<span class="number">65536</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packets:<span class="number">0</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packets:<span class="number">0</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span><br><span class="line">          collisions:<span class="number">0</span> txqueuelen:<span class="number">0</span></span><br><span class="line">          RX bytes:<span class="number">0</span> (<span class="number">0.0</span> B)  TX bytes:<span class="number">0</span> (<span class="number">0.0</span> B)</span><br><span class="line"></span><br><span class="line">venet0    Link encap:UNSPEC  HWaddr <span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span></span><br><span class="line">          inet addr:<span class="number">127.0</span><span class="number">.0</span><span class="number">.2</span>  P-t-P:<span class="number">127.0</span><span class="number">.0</span><span class="number">.2</span>  Bcast:<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>  Mask:<span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span></span><br><span class="line">          UP BROADCAST POINTOPOINT RUNNING NOARP  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packets:<span class="number">7054342</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packets:<span class="number">5911869</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span><br><span class="line">          collisions:<span class="number">0</span> txqueuelen:<span class="number">0</span></span><br><span class="line">          RX bytes:<span class="number">9292344012</span> (<span class="number">9.2</span> GB)  TX bytes:<span class="number">1060426275</span> (<span class="number">1.0</span> GB)</span><br><span class="line"></span><br><span class="line">venet0:<span class="number">0</span>  Link encap:UNSPEC  HWaddr <span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span>-<span class="number">00</span></span><br><span class="line">          inet addr:<span class="number">192.1</span><span class="number">.2</span><span class="number">.3</span>  P-t-P:<span class="number">192.1</span><span class="number">.2</span><span class="number">.3</span>  Bcast:<span class="number">192.1</span><span class="number">.2</span><span class="number">.3</span>  Mask:<span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span></span><br><span class="line">          UP BROADCAST POINTOPOINT RUNNING NOARP  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br></pre></td></tr></table></figure><br>其中<code>lo</code>代表本地回环地址，<code>venet0</code>是OpenVZ架构虚拟机中的第一块虚拟网卡，<code>venet0:0</code>是venet0的别名。</p>
<h2 id="iptables_命令解释">iptables 命令解释</h2><p>iptables常用命令解释：</p>
<ul>
<li>-A chain, –append  添加一条新规则</li>
<li>-D chain [rulenumder], –delete  删除一条规则</li>
<li>-I chain [rulenumder], –insert  插入一条规则</li>
<li>-R chain [rulenumber], –replace  替换一条规则</li>
<li>-L [chain [rulenumber]], –list  列出所有规则</li>
<li>-P, –policy 策略</li>
<li>-i, –in-interface  网络接口名称</li>
<li>-m match, –match  扩展匹配</li>
<li>-p proto, –protocol  协议，如’tcp’，’udp’</li>
<li>-j target, –jump 参数用来指定要进行的处理动作，常用的处理动作包括：ACCEPT、REJECT、DROP、REDIRECT、MASQUERADE等</li>
</ul>
<p>链(chain)：链是一些按顺序排列的规则的列表，iptables 默认的 filter 表包含 INPUT， OUTPUT 和 FORWARD 3条内建的链。</p>
<h2 id="允许连接">允许连接</h2><p>首先允许本地回环端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -i lo -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>允许建立关联连接<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>允许访问特定端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p tcp --dport <span class="number">12345</span> -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>如，允许ssh端口：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p tcp --dport <span class="number">22</span> -j ACCEPT</span><br><span class="line"><span class="comment"># 如果更改了默认ssh端口要更改为修改后的端口（如上文中的12345）</span></span><br></pre></td></tr></table></figure></p>
<p>允许FTP端口：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p tcp --dport <span class="number">21</span> -j ACCEPT</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport <span class="number">20</span> -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>同时开放多个端口：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p tcp -m multiport --dport <span class="number">20</span>,<span class="number">21</span> -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>允许接收ping<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p icmp --icmp-type <span class="built_in">echo</span>-request -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>接收ping后可以通过ping命令在本地服务端测试网络延迟，但是也会使其他人通过ping来知晓该服务器地址的可用性，如无特殊需要可以不接受所有ping。</p>
<h2 id="阻止其他连接">阻止其他连接</h2><p>最后，在以上允许连接的基础上阻止所有其他连接：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -j REJECT</span><br><span class="line">sudo iptables -A FORWARD -j REJECT</span><br></pre></td></tr></table></figure></p>
<p><strong>注意</strong>：在阻止所有连接之前一定要将允许ssh端口的连接，否则规则生效后会直接断开ssh连接并且无法重新连接。这时只能进入管理后台取消该组织规则，或者重装系统。</p>
<h2 id="编辑已存在规则">编辑已存在规则</h2><p>将所有的iptables规则以序号标记显示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -L -n --line-numbers</span><br></pre></td></tr></table></figure></p>
<p>显示如下：<br><figure class="highlight sql"><figcaption><span>sudo iptables -L -n --line-numbers</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination</span><br><span class="line">1    ACCEPT     tcp  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            tcp dpt:12345</span></span><br><span class="line">2    ACCEPT     all  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED</span></span><br><span class="line">3    ACCEPT     tcp  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            tcp dpt:20</span></span><br><span class="line">4    ACCEPT     udp  <span class="comment">--  0.0.0.0/0            0.0.0.0/0            multiport dports 2000,3000</span></span><br><span class="line">5    ACCEPT     all  <span class="comment">--  0.0.0.0/0            0.0.0.0/0</span></span><br><span class="line">6    <span class="operator"><span class="keyword">DROP</span>       all  <span class="comment">--  0.0.0.0/0            0.0.0.0/0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Chain</span> FORWARD (<span class="keyword">policy</span> <span class="keyword">ACCEPT</span>)</span><br><span class="line"><span class="keyword">num</span>  target     prot opt <span class="keyword">source</span>               destination</span><br><span class="line"></span><br><span class="line"><span class="keyword">Chain</span> <span class="keyword">OUTPUT</span> (<span class="keyword">policy</span> <span class="keyword">ACCEPT</span>)</span><br><span class="line"><span class="keyword">num</span>  target     prot opt <span class="keyword">source</span>               destination</span></span><br></pre></td></tr></table></figure></p>
<p>现在INPUT 链中已经有6条规则了，现在来修改已经存在的规则。</p>
<h3 id="删除一条规则">删除一条规则</h3><p>比如：删除第6条规则<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -D INPUT <span class="number">6</span></span><br></pre></td></tr></table></figure></p>
<h3 id="插入一条规则">插入一条规则</h3><p>在第2条规则之前插入一条规则<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -I INPUT <span class="number">2</span> -p tcp -i venet0 --dport <span class="number">1234</span> -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<h2 id="保存规则与恢复规则">保存规则与恢复规则</h2><p>在Ubuntu上 iptables 默认是不会保存已经设置的规则，系统重启后所有规则将丢失，所以需要将已有规则保存下来。</p>
<h3 id="手动保存规则">手动保存规则</h3><figure class="highlight stata"><figcaption><span>root #</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 由于sudo只作用于其后跟的第一个命令，所以以下命令中<span class="string">"&gt;"</span>会因为没有写入权限而无法运行，所以直接切换到root用户运行命令。</span><br><span class="line"><span class="keyword">su</span> root</span><br><span class="line">iptables-<span class="keyword">save</span> &gt; /etc/iptables.<span class="keyword">input</span>.rules</span><br></pre></td></tr></table></figure>
<p>保存规则后，设置开机自动从文件恢复规则。编辑开机启动文件/etc/rc.local<br>在<code>exit 0</code>之前写入以下命令<br><figure class="highlight sql"><figcaption><span>/etc/rc.local</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables-<span class="operator"><span class="keyword">restore</span> &lt; /etc/iptables.<span class="keyword">input</span>.<span class="keyword">rules</span></span></span><br></pre></td></tr></table></figure><br>保存退出。</p>
<h3 id="自动保存规则">自动保存规则</h3><p>让网卡关闭时自动保存规则，网卡开启时自动恢复规则。<br>创建/etc/network/if-post-down.d/iptables 文件，添加如下内容：<br><figure class="highlight bash"><figcaption><span>/etc/network/if-post-down.d/iptables</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line">iptables-save &gt; /etc/iptables.input.rules</span><br></pre></td></tr></table></figure><br>为文件添加执行权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /etc/network/<span class="keyword">if</span>-post-down.d/iptables</span><br></pre></td></tr></table></figure></p>
<p>创建/etc/network/if-pre-up.d/iptables 文件，添加如下内容：<br><figure class="highlight bash"><figcaption><span>/etc/network/if-pre-up.d/iptables</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line">iptables-restore &lt; /etc/iptables.input.rules</span><br></pre></td></tr></table></figure><br>为文件添加执行权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /etc/network/<span class="keyword">if</span>-pre-up.d/iptables</span><br></pre></td></tr></table></figure></p>
<p>当网络关闭或开启时就会自动保存与恢复iptables规则。</p>

            
                

            
        </div>
    </div>
    <div class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Linux/">Linux</a> <a class="tag tag--primary tag--small t-link" href="/tags/iptables/">iptables</a> <a class="tag tag--primary tag--small t-link" href="/tags/ssh/">ssh</a> <a class="tag tag--primary tag--small t-link" href="/tags/vps/">vps</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/10/build-hexo-blog3/" data-tooltip="用Hexo搭建静态博客（三）, 设置自定义域名">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=http://libhappy.com/2015/12/vps-protect/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
       
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=http://libhappy.com/2015/12/vps-protect/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>

        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://libhappy.com/2015/12/vps-protect/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>

        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" data-tooltip="View comments" href="#comments">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" data-tooltip="Back to top" href="#">
                    <i class="fa fa-chevron-up"></i>
            
            </a>
        </li>
    </ul>
</div>


        
            <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-vps-protect" data-title="Linux服务器的简单防护" data-url="http://libhappy.com/2015/12/vps-protect/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'libhappy'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
 </section>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2015 Arthur. All Rights Reserved.<br>
        Static pages hosted in <a class="theme-link" href="https://github.com/" rel="external nofollow">Github</a>, Pictures hosted in <a class="theme-link" href="https://www.flickr.com/photos/walktodream/albums/72157659807930798" rel="external nofollow">Flickr</a>
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="1">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/10/build-hexo-blog3/" data-tooltip="用Hexo搭建静态博客（三）, 设置自定义域名">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Google+" href="https://plus.google.com/share?url=http://libhappy.com/2015/12/vps-protect/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
       
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Twitter" href="https://twitter.com/intent/tweet?text=http://libhappy.com/2015/12/vps-protect/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>

        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://libhappy.com/2015/12/vps-protect/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>

        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" data-tooltip="View comments" href="#comments">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" data-tooltip="Back to top" href="#">
                    <i class="fa fa-chevron-up"></i>
            
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="1">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://libhappy.com/2015/12/vps-protect/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google+</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://libhappy.com/2015/12/vps-protect/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://libhappy.com/2015/12/vps-protect/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        <div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg"/>
        
            <h4 id="about-card-name">Arthur</h4>
        
            <h5 id="about-card-bio"><p>Happy coding, Happy life.</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Whatever</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                China
            </h5>
        
    </div>
</div>

        <div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->


    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
                (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
            e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','xKFF8yFHuuQLQqpiGZt3','2.0.0');
    </script>


</html>
